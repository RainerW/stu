#set($filename = ${model.name} + ${model.suffix} )
#set($package  = ${model.package} )
#if( $package && $package.length() != 0 )
package ${package};
#end
##
## ************************************************************
## *                   Begin of File                          * 
## ************************************************************
##
import com.seitenbau.testing.dbunit.util.DbCompare;
import com.seitenbau.testing.util.DateUtil;
import com.seitenbau.testing.util.date.DateBuilder;
import com.seitenbau.testing.dbunit.extend.DatasetIdGenerator;
import com.seitenbau.testing.dbunit.extend.impl.DefaultIdGenerator;
import org.dbunit.dataset.DefaultDataSet;
import org.dbunit.dataset.IDataSet;
import java.util.Date;

#foreach( $table in $model.tables )
#set($rowbuilder   = "RowBuilder_" + ${table.javaName} )
#set($rowmodel     = ${table.javaName} + "Model" )
#set($tableClass   = ${table.javaName} + ${table.suffix} )
import ${package}.${tableClass}.${rowbuilder};
import ${package}.${rowmodel};
#end

/*********************************************************
  {@link DbUnitDatasetFactory} factory to create in-memory 
  {@link IDataSet} for your Database. 
  </br>
  This class is generated by ${model.caller}
**********************************************************/
public abstract class ${model.name}${model.suffix}
             implements com.seitenbau.testing.dbunit.extend.DbUnitDatasetFactory
{
  /** 
   * Now at time of creation, This is 'fixed' so the time can be used when
   * adding multipe lines, it's still kind of 'now' but can be predicted.
   */ 
  DateBuilder _jetzt = DateUtil.datum();
  
  /**
   * Reference to an {@link DatasetIdGenerator}. Used to set IDs.
   * See Flags when adding an columnin your model to create nextId()
   * methods.
   */
  DatasetIdGenerator _idGenerator;

  // All Tables as instances ( see {@link #prepareTables} for init code ) 
#foreach( $table in $model.tables )
  public ${table.javaName}Table table_${table.javaName} = new ${table.javaName}Table();
#end

  /**
   * Create a new instance of this DbUnitDatasetFactory. This
   * will create all tables and invoke the template methods to
   * modify the DataSet content.<br/> 
   * To inject your own data use the initDataSet() method.
   */
  public ${model.name}${model.suffix}() 
  {
    prepareTables();
    beforeInitDataSet();
    initDataSet();
    afterInitDataSet();
  }
  
  /**
   * Create the actual DBUnit IDataSet.
   */
  public IDataSet createDBUnitDataSet()
  {
    beforeDataSetCreation();
#if( $model.createException ) try { #end
    DefaultDataSet dataSet = new DefaultDataSet();
#foreach( $table in $model.tables )
    dataSet.addTable(table_${table.javaName});
    table_${table.javaName}.resetIterator();
#end
     afterDataSetCreation(dataSet);
     return finalModify( dataSet );
#if( $model.createException )
    } catch($model.createException e) {
       throw new RuntimeException(e);
    } 
#end
  }
  
  /**
   * Injection point. Last processing template method to modify the resulting 
   * Dataset created by createDBUnitDataSet(). 
   * You should really know what you're doing!
   *
   * @param dataSet
   * @return
   */
  protected DefaultDataSet finalModify(DefaultDataSet dataSet)
  {
    return dataSet;
  }
  
  /**
   * Template Method, get's called after createDBUnitDataSet() method
   * Use this only if really needed.
   */
  protected void afterDataSetCreation(DefaultDataSet dataSet) #if( $model.createException ) throws $model.createException#end
  {
  }

  /**
   * Template Method, get's called before createDBUnitDataSet() method.
   * Use this only if really needed. 
   */
  protected void beforeDataSetCreation()
  {
  }
  
  /**
   * Template Method, got called after the initDataSet() method
   */
  protected void afterInitDataSet()
  {
  }

  /**
   * Inner method to prepare the table instances.
   * Do not overwrite.
   */
  protected void prepareTables()
  {
#foreach( $table in $model.tables )
    table_${table.javaName}.setDataset(this);
#end
  }
  
  /**
   * Template Method, got called before the initDataSet() method
   */
  protected void beforeInitDataSet()
  {
  }

  /**
   * Initialize the content of your Dataset here.
   */
  abstract protected void initDataSet();
  
  /** 
   * Compare the given Date to be 'equal' around (+-15s). 
   */
  public Date around(DateBuilder datum) 
  {
      return DbCompare.warp(datum);
  }

  /** 
   * <p>
   * Create org get the 'current' timestamp as DateBuilder. 
   * Subsequent calls will give you the same builder and TIME again!
   * This allows you to use the same "now" for the whole dataset.<br>
   * <b>!!But be aware that this will be a fixed now, of the time where the 
   * Factory was created!!</b> 
   * </p>
   */
  public DateBuilder jetzt()
  {
    return _jetzt;
  }
  
  /**
   * Change the used id generator
   **/
  public void setIdGenerator(DatasetIdGenerator gen)
  {
    _idGenerator = gen;
  }
  
  /**
   * Return the current active {@link DatasetIdGenerator}
   */
  public DatasetIdGenerator getIdGenerator()
  {
    if(_idGenerator == null) 
    {
      _idGenerator = new DefaultIdGenerator();
    }
    return _idGenerator;
  }
  
  
  /** run the given modifiers on this dataset */
  public ${model.name}${model.suffix} modify(${model.name}${model.suffix}Modifier...modifiers) 
  {
    if(modifiers==null) { return this; }
    for(${model.name}${model.suffix}Modifier modifier : modifiers) 
    {
      modifier.modify(this);
    }
    return this;
  }
  
  /**
   * Interface for the double dispatch. Used by {@link #modify} to
   * extract creation logic into an external strategy.
   */ 
  public static interface ${model.name}${model.suffix}Modifier {
    void modify(${model.name}${model.suffix} dataset);
  }
  
  /* ************************************************************ */
  /* *             convenient add(*) methods                    * */
  /* ************************************************************ */
  
#foreach( $table in $model.tables )
#set($rowbuilder   = "RowBuilder_" + ${table.javaName} )
#set($rowmodel     = ${table.javaName} + "Model" )
  /** 
   * Adds the given row into the Table '${table.name}'
   */
  public $rowbuilder add(${rowbuilder} row) 
  {
    return table_${table.javaName}.insertRow(row);
  }
  /** 
   * Adds the given row into the Table '${table.name}'
   */
  public $rowbuilder add(${rowmodel} row) 
  {
    return table_${table.javaName}.insertRow(row);
  }
  /**
   * ! work in progress !
   * create a new Model of the Type ${rowmodel} with 
   * the same IdGenerator that this Dataset  
   */
  /*
  public ${rowmodel} create${table.javaName}() 
  {
    ${rowmodel} model = new ${rowmodel}();
    model.setIdGenerator(getIdGenerator());
#foreach( $column in $table.columns )
#if( $column.isNextIdMethodGenerated() )
    model.next${column.javaName}();
#end
#end
    return model;
  }
  */
#end
}
